{% extends 'layout.html' %} {% block styles %}
<script src="https://apis.google.com/js/api.js"></script>
<style>

	.scrollable-card-container {
		/* max-height: 1000px; */
		max-width: 1000px;
		overflow-y: auto;
	}

	.card {
		width: 29%; /* Reduce card width */
		background-color: #888888;
		padding: 6px; /* Reduce padding */
		margin-bottom: 10px; /* Reduce bottom margin */
		margin-left: 0.6%; /* Small left margin to keep spacing consistent */
		margin-right: 0.6%; /* Small right margin */
		border-radius: 8px;
		box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
		font-size: 11px; /* Reduce font size for text */
		/* font-weight: bold; */
		color: white;
	}

	.card-container {
		display: flex;
		flex-wrap: wrap;
		justify-content: space-around; /* Space between cards */
	}

	.card img {
		width: 100%; /* Ensure the image fills the width of the card */
		height: auto; /* Keep aspect ratio of the image */
		max-height: 250px; /* Set max height to keep images uniform */
	}

	#predictedMovies .card {
		width: 18%;
		margin: 0.5%;
	}

	body {
		font-family: "Noto Sans", sans-serif;
		background-color: #141414;
		color: white;
		background-size: cover;
	}
	body::after {
		content: "";
		background-image: url("https://wallpaperaccess.com/full/8212583.jpg") no-repeat
			center center fixed;
		background-size: cover;
		opacity: 0.5;
		top: 0;
		left: 0;
		bottom: 0;
		right: 0;
		position: fixed;
		z-index: -1;
		background-color: rgb(0, 0, 0);
	}

	.btn {
		padding: 8px 15px; /* Adjust button padding */
		font-size: 14px; /* Adjust button font size */
		cursor: pointer;
	}

	.red-button {
		background-color: #d9534f;
		color: white;
		border: none;
		padding: 5px 10px;
		text-decoration: none;
		font-size: 16px;
		cursor: pointer;
		display: inline-block;
		max-width: 120px;
		height: 60px; /* Match the height of the header */
		text-align: center;
	}

	.btn-primary {
		background-color: #d9534f;
		color: white;
		border: none;
		padding: 5px 10px;
		margin-top: 10%;
		text-decoration: none;
		font-size: 10px;
		cursor: pointer;
		display: inline-block;
		max-width: 100px;
		height: 50px; /* Adjust the height */
		text-align: center;
	}

	#paginationButtons button {
		margin: 0 5px;
		padding: 5px 10px;
		cursor: pointer;
		border: 1px solid #d9534f;
		background-color: #d9534f;
		color: #fff; /* White text */
		font-size: 14px;
		transition: background-color 0.3s, color 0.3s;
	}

	#paginationButtons button:hover {
		background-color: #fff; /* White background on hover */
		color: #000; /* Black text on hover */
	}

	#paginationButtons button.active {
		background-color: #fff; /* White background for active button */
		color: #000; /* Black text for active button */
		font-weight: bold;
	}
	.socials {
		display: flex;
		justify-content: space-evenly;
	}
	.socials-icon:hover {
		color: whitesmoke;
		opacity: 0.8;
		transition-duration: 1s;
	}
	.socials-icon {
		width: 50px;
		height: 50px;
		font-size: 28px;
		display: flex;
		justify-content: center;
		align-items: center;
		text-decoration: none;
		color: white;
		border-radius: 5px;
		transition-duration: 1s;
	}
	.fa-whatsapp {
		background-color: #25d366;
		padding: 5px;
		border-radius: 5px;
	}
	.fa-facebook {
		background-color: #1877f2;
		border-radius: 5px;
		padding: 5px;
	}
	.fa-twitter {
		background-color: #1da1f2;
		border-radius: 5px;
		padding: 5px;
	}

	.modal-body{
		color: black;
	}
	.review-title{
		color: black;
	}
</style>
{% endblock %} {% block content %}

<div class="bg">
	<!-- Main Container -->
<div class="container my-5">
	<!-- Centered Search Bar and Refresh Button -->

	<div class="row text-center mb-4">
		<h2 class="text-light fw-bold">Search for Movies</h2>
	</div>
	<div class="row text-center mb-4">
		<div
			class="col-md-8 mx-auto d-flex justify-content-center align-items-center">
			<input
				type="text"
				name="search"
				id="searchBox"
				class="form-control"
				style="max-width: 500px"
				placeholder="Search Here" />
			<input
				type="button"
				class="btn btn-danger ms-3"
				name="predict"
				id="predict"
				value="Predict"
				style="height: 60px" />
			<button class="btn btn-danger ms-3" id="refreshBtn" style="height: 60px">
				Refresh
			</button>
		</div>
	</div>

	<!-- Filters Section -->
	<div class="row mb-4">
		<div class="col-md-12">
			<label for="genre-select" class="form-label text-light"
				>Filter by Genres:</label
			>
			<select id="genre-select" class="form-control" multiple>
				<option value="Action">Action</option>
				<option value="Adventure">Adventure</option>
				<option value="Comedy">Comedy</option>
				<option value="Drama">Drama</option>
				<option value="Horror">Horror</option>
				<option value="Romance">Romance</option>
				<option value="Sci-Fi">Sci-Fi</option>
			</select>
		</div>
		<div class="col-md-12">
			<label for="rating-filter" class="form-label text-light"
				>Filter by Rating (min):</label
			>
			<input
				type="number"
				id="rating-filter"
				class="form-control"
				placeholder="Enter min rating (0-10)"
				min="0"
				max="10" />
		</div>
	</div>
	<div class="text-center mb-4">
		<button class="btn btn-danger" id="filterMovies">Apply Filters</button>
	</div>

	<!-- Selected Movies and Predict Button -->
	<div class="row">
		<div class="col-md-10">
			<h2 class="text-light fw-bold">Predicted Movies</h2>
			<div class="scrollable-card-container">
				<div id="paginationButtons"></div>
				<div id="predictedMovies" class="card-container"></div>
			</div>
		</div>
		<div class="col-md-2">
			<h2 class="text-light fw-bold">Selected Movies</h2>
			<ul id="selectedMovies" class="list-unstyled">
				<div class="card-container">
					{% for movie in training_data %}
					<div class="card mb-2">
						<h5>{{ movie.title }}</h5>
						<p>Rating: {{ movie.rating }}</p>
						<p>IMDb Rating: {{ movie.imdbRating }}</p>
					</div>
					{% endfor %}
				</div>
			</ul>
		</div>
	</div>

	<!-- Submit All Feedback Button -->
	<div class="container text-center mb-4">
		<button id="submitAllFeedback" class="btn btn-primary" style="display: none">
			Submit Feedback
		</button>
	</div>
</div>

<!-- Reviews Dialog (hidden initially) -->
<div class="modal fade" id="reviewsDialog" tabindex="-1" aria-labelledby="reviewsDialogLabel" aria-hidden="true">
	<div class="modal-dialog">
	  <div class="modal-content">
		<div class="modal-header">
		  <h5 class="review-title" id="reviewsDialogLabel">Movie Reviews</h5>
		  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		</div>
		<div class="modal-body" id="reviewsContent">
		  <!-- Content  -->
		</div>
		<div class="modal-footer">
		  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
		</div>
	  </div>
	</div>
  </div>
  
<!-- Streaming Platforms Dialog (hidden initially) -->
<!-- <div
	id="platformsDialog"
	title="Available Streaming Platforms"
	style="display: none">
	<div id="platformsContent" class="d-flex justify-content-around"></div>
</div> -->
<!-- Modal Structure -->
<div class="modal fade" id="platformsDialog" tabindex="-1" aria-labelledby="platformsDialogLabel" aria-hidden="true">
	<div class="modal-dialog">
	  <div class="modal-content">
		<div class="modal-header">
		  <h5 class="review-title" id="platformsDialogLabel">Available Streaming Platforms</h5>
		  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		</div>
		<div class="modal-body d-flex justify-content-around" id="platformsContent">
		  <!-- Platforms content will go here -->
		</div>
		<div class="modal-footer">
		  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
		</div>
	  </div>
	</div>
  </div>
  

<!-- Data Collected Message (hidden initially) -->
<div id="dataCollected" class="container text-center" style="display: none">
	<h1 class="text-light fw-bold">Thanks! Your response was stored.</h1>
	<input
		type="button"
		id="refreshPage"
		class="btn btn-danger"
		value="Take another attempt" />
</div>
</div>

{% endblock %} {% block scripts %}
<script>
	var apiKey = "AIzaSyBkk7lYRb1WZCB1QmEu5t_GzF0crk2cd3I";
	gapi.load("client", initYouTubeAPI);
	function initYouTubeAPI() {
		gapi.client
			.init({
				apiKey: apiKey,
				discoveryDocs: [
					"https://www.googleapis.com/discovery/v1/apis/youtube/v3/rest",
				],
			})
			.then(function () {
				console.log("YouTube API initialized");
			});
	}

	// Function to show reviews in a dialog box when "Check Reviews" button is clicked
	function showReviews(movieTitle) {
		// Send the original movie title to the backend
		$.ajax({
			type: "GET",
			url: `/get_reviews/${encodeURIComponent(movieTitle)}`, // Fetch reviews from the backend
			success: function (response) {
				var reviewsHtml = "";

				// Loop through the reviews and generate HTML content
				response.reviews.forEach(function (review) {
					reviewsHtml += `<p><strong>${review.author}</strong>: ${review.content}</p>`;
				});

				// Handle the case where there are no reviews
				if (reviewsHtml === "") {
					reviewsHtml = "<p>No reviews available for this movie.</p>";
				}

				// Update the modal content
				$("#reviewsContent").html(reviewsHtml);

				// Show the modal
				$('#reviewsDialog').modal('show');

				
			},
			error: function (error) {
				console.log("Error fetching reviews:", error);
				$("#reviewsContent").html(
					"<p>Failed to load reviews. Please try again later.</p>"
				);
				$("#reviewsDialog").dialog({
					modal: true,
					width: 600,
					buttons: {
						Close: function () {
							$(this).dialog("close");
						},
					},
				});
			},
		});
	}

	// Function to show streaming platforms in a dialog box when "Check Streaming Platforms" button is clicked
	function showStreamingPlatforms(movieTitle, index) {
		// Clear any previous platform data
		$("#platformsContent").html("<p>Loading streaming platforms...</p>");

		// Fetch the streaming providers for the movie when the button is clicked
		$.ajax({
			type: "GET",
			url: `/get_streaming_platforms/${encodeURIComponent(movieTitle)}`,
			success: function (response) {
				var streamingHtml = "";

				// Check if platforms are available in the response
				if (response.length === 0) {
					// If no platforms are available, show a message
					streamingHtml = "<p>This movie is not available in the US region.</p>";
				} else {
					// Only show the first four platforms
					var platforms = response.slice(0, 4);
					platforms.forEach(function (platform) {
						streamingHtml += `
							<div class="text-center">
								<img src="${platform.logo}" alt="${platform.name}" style="width: 50px; height: 50px;">
								<p>${platform.name}</p>
							</div>`;
					});
				}

				// Insert streaming platforms or the message into the modal content
				$("#platformsContent").html(streamingHtml);

				// Show the Bootstrap modal
				$('#platformsDialog').modal('show');

			},
			error: function (error) {
				console.log("Error fetching streaming platforms:", error);
				$("#platformsContent").html("<p>Failed to load streaming platforms.</p>");
			},
		});
	}
</script>
<script>
	$(document).ready(function () {
		// Store predicted movies for filtering
		let allPredictedMovies = [];
		// Global variables for pagination
		const moviesPerPage = 5; // Number of movies per page
		let totalPages = 0;

		function displayErrorMessage(message) {
			$("#errorMessageText").text(message);
			$("#errorMessage").show(); // Show the error card
			$("#main").css("opacity", "0.1");
		}

		$(function () {
			$("#searchBox").autocomplete({
				source: function (request, response) {
					$.ajax({
						type: "POST",
						url: "http://localhost:5000/search",
						dataType: "json",
						cache: false,
						data: {
							q: request.term,
						},
						success: function (data) {
							//alert(data);
							// console.log(data);
							response(data);
						},
						error: function (jqXHR, textStatus, errorThrown) {
							console.log(textStatus + " " + errorThrown);
						},
					});
				},
				select: function (event, ui) {
					var ulList = $("#selectedMovies");

					// Create a new list item (li) and add the selected movie value
					//var li = $("<li/>").addClass("list-group-item").text(ui.item.value).appendTo(ulList);

					// Create the Bootstrap card with the remove button
					var card = $("<div/>", {
						class: "card",
						css: {width: "18rem", marginBottom: "10px"},
					}).append(
						$("<div/>", {class: "card-body"})
							.append($("<h5/>", {class: "card-title", text: ui.item.value})) // Movie title
							.append(
								$("<p/>", {
									class: "card-text",
									text: "",
								})
							) // Movie description
							.append(
								$("<button/>", {
									text: "Remove",
									class: "btn btn-danger",
									css: {
										borderRadius: "5px",
										padding: "5px 10px",
										marginTop: "10px",
									},
									click: function () {
										$(this).closest(".card").remove(); // Remove the card on click
									},
								})
							)
					);

					// Append the card to the list item
					card.appendTo(ulList);

					// Clear the search input
					$("#searchBox").val("");

					return false; // Prevent default behavior
				},
				minLength: 2,
			});
		});

		// Function to create pagination buttons
		function createPaginationButtons(numberOfMovies, movies) {
			const paginationContainer = $("#paginationButtons");
			paginationContainer.empty();

			totalPages = Math.ceil(numberOfMovies / moviesPerPage);

			for (let i = 1; i <= totalPages; i++) {
				const button = $(`<button id="pageButton${i}">${i}</button>`);
				button.click(function () {
					displayMoviesForPage(i, movies);
				});

				paginationContainer.append(button);
			}
		}

		$("#predict").click(function () {
			var movie_list = [];
			$("#selectedMovies .card").each(function () {
				var movieTitle = $(this).find(".card-title").text().trim();
				// Push the extracted title to the movie_list
				movie_list.push(movieTitle);
			});

			var movies = {movie_list: movie_list};

			// Clear previous predicted movies and show loading message
			$("#predictedMovies").empty();
			$("#predictedMovies").append(
				`<div id="loadingMessage" style="color: #ebe5e6; font-size: 24px; font-weight: bold;">Loading...</div>`
			);
			$("#paginationButtons").empty();

			$.ajax({
				type: "POST",
				url: "/predict",
				dataType: "json",
				contentType: "application/json;charset=UTF-8",
				traditional: "true",
				cache: false,
				data: JSON.stringify(movies),
				success: function (response) {
					var predictedMovies = $("#predictedMovies");
					predictedMovies.empty();

					// Store all predicted movies for filtering later
					allPredictedMovies = response["recommendations"];

					// displayMovies(allPredictedMovies);

					// Create pagination buttons
					createPaginationButtons(allPredictedMovies.length, allPredictedMovies);

					// Initialize and display the first page of movies
					displayMoviesForPage(1, allPredictedMovies);

					$("#submitAllFeedback").show();
				},
				error: function (error) {
					console.log("ERROR ->", error);
				},
			});
		});

		// TODO: how to maintain the filter functionality for pagination
		// Function to display movies for a specific page
		function displayMoviesForPage(page, movies) {
			const predictedMovies = $("#predictedMovies");
			predictedMovies.empty();

			const startIndex = (page - 1) * moviesPerPage;
			const endIndex = startIndex + moviesPerPage;

			const moviesToDisplay = movies.slice(startIndex, endIndex);

			// Update button states
			for (let i = 1; i <= totalPages; i++) {
				const button = $("#pageButton" + i);

				if (i === page) {
					button.addClass("active");
				} else {
					button.removeClass("active");
				}
			}

			// Render movies for the current page
			moviesToDisplay.forEach(function (movie, index) {
				var movieCard = `
                    <div class="card">
                        <img src="${movie.poster}" alt="Movie Poster">
                        <h5 class="card-title">${movie.title}</h5>
                        <p class="card-text">IMDb Rating: ${movie.rating}</p>
                        <p class="card-text">Genre: ${movie.genres}</p>
						<p class="card-text">Cast: ${movie.cast}</p>
						<p class="card-text">Plot: ${movie.plot}</p>
						<a href="https://www.imdb.com/title/${movie.imdb_id}" role="button" target="_blank"><button class="btn btn-primary" >IMDb link</button></a>
  

                        <!-- Watchlist Button -->
                        <form action="/add_to_watchlist" method="POST">
                            <input type="hidden" name="movie_title" value="${movie.title}">
                            <input type="hidden" name="imdb_rating" value="${movie.rating}">
                            <button type="submit" class="btn btn-primary">Add to Watchlist</button>
                        </form>

    <!-- Reviews -->
    <button class="btn btn-primary" id="reviews-button-${index}" onclick="showReviews('${movie.title}')">Check Reviews</button>
    
    <!-- Check Streaming Platforms Button -->
    <button class="btn btn-primary" id="platforms-button-${index}" onclick="showStreamingPlatforms('${movie.title}', ${index})">Streaming Platforms</button>

    <!-- Feedback -->
    <label for="feedback-${index}">Feedback:</label>
    <select class="form-control" id="feedback-${index}">
        <option value="Yet to Watch" style="font-size: 10px;">Yet to Watch</option>
        <option value="Like" style="font-size: 10px;">Like</option>
        <option value="Dislike" style="font-size: 10px;">Dislike</option>
    </select>

    <!-- Social Media Share Links -->
    <div class="socials">
		<a href="https://wa.me/?text=Check out this movie: ${movie.title} - IMDb Rating: ${movie.rating} ${window.location.href}" target="_blank" class="socials-icon ">
			<i class="fa-brands fa-whatsapp"></i>
		</a>
		<a href="https://www.facebook.com/sharer/sharer.php?u=${window.location.href}" target="_blank" class="socials-icon ">
			<i class="fa-brands fa-facebook"></i>
		</a>
		<a href="https://twitter.com/intent/tweet?text=Check out this movie: ${movie.title} - IMDb Rating: ${movie.rating} ${window.location.href}" target="_blank" class="socials-icon ">
			<i class=" fa-brands fa-twitter"></i>
		</a>
	 </div>
</div>

                `;
				predictedMovies.append(movieCard);
			});
		}
		
		// Submit All Feedback Logic
		$("#submitAllFeedback").click(function () {
			var feedbackData = {};
			$("#predictedMovies .card").each(function (index, card) {
				var feedback = $(card).find(`#feedback-${index}`).val();
				var movieTitle = $(card).find(".card-title").text();

				if (feedback) {
					feedbackData[movieTitle] = feedback;
				}
			});

			// Submit all feedback at once
			$.ajax({
				type: "POST",
				url: "/feedback",
				dataType: "json",
				contentType: "application/json;charset=UTF-8",
				traditional: "true",
				cache: false,
				data: JSON.stringify(feedbackData),
				success: function () {
					alert("All feedback submitted successfully");
				},
				error: function (error) {
					console.log("ERROR ->", error);
					alert("Failed to submit feedback");
				},
			});
		});

		// Filtering Logic
		$("#filterMovies").click(function () {
			$("#predictedMovies").empty();
			$("#predictedMovies").append(
				`<div id="loadingMessage" style="color: #ebe5e6; font-size: 24px; font-weight: bold;">Loading...</div>`
			);
			$("#paginationButtons").empty();
			const selectedGenres = $("#genre-select").val(); // Get selected genres
			const minRating = parseFloat($("#rating-filter").val()); // Get minimum rating

			const filteredMovies = allPredictedMovies.filter((movie) => {
				const genreMatch =
					selectedGenres.length === 0 ||
					selectedGenres.some((genre) => movie.genres.includes(genre));
				const ratingMatch = isNaN(minRating) || movie.rating >= minRating;
				return genreMatch && ratingMatch;
			});

			// Create pagination buttons
			createPaginationButtons(filteredMovies.length, filteredMovies);

			// Initialize and display the first page of movies
			displayMoviesForPage(1, filteredMovies);
		});

		function fetchYouTubeVideoLinks(movieTitle, cardBody) {
			var request = gapi.client.youtube.search.list({
				q: movieTitle + " official trailer",
				part: "snippet",
				type: "video",
				maxResults: 1,
			});

			request.execute(function (response) {
				var videos = response.items;

				if (videos.length > 0) {
					var trailersHeading = document.createElement("h5");
					//trailersHeading.textContent = 'Trailers:';
					cardBody.appendChild(trailersHeading);

					var trailersList = document.createElement("ul");

					videos.forEach(function (video) {
						var videoId = video.id.videoId;
						var videoLink = "https://www.youtube.com/watch?v=" + videoId;

						var trailerItem = document.createElement("a");
						var youtubeLink = document.createElement("a");
						youtubeLink.href = videoLink;
						youtubeLink.target = "_blank";
						youtubeLink.textContent = "Watch Trailer ";

						trailerItem.appendChild(youtubeLink);
						trailersList.appendChild(trailerItem);
					});

					cardBody.appendChild(trailersList);
				}
			});
		}

		$("#refreshBtn").click(function () {
			location.reload(); // This will refresh the whole page
		});
	});
</script>

{% endblock %}
